name: Auto Release (date tag)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

# Ensure we can create/delete tags & releases
permissions:
  contents: write

# Prevent overlapping runs for the same branch
concurrency:
  group: "auto-release-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make tag name
        id: mk
        run: |
          TAG="$(date -u +%Y.%m.%d)"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Ensure GitHub CLI is authenticated
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh auth status

      # If a release (and its tag) already exists for today, remove them so we can recreate
      - name: Delete existing release (if any)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view "${{ steps.mk.outputs.tag }}" > /dev/null 2>&1; then
            echo "Existing release ${{ steps.mk.outputs.tag }} found â€” deleting..."
            gh release delete "${{ steps.mk.outputs.tag }}" -y
          else
            echo "No existing release named ${{ steps.mk.outputs.tag }} found"
          fi

      - name: Delete existing tag ref (if any)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/${{ steps.mk.outputs.tag }}" || echo "Tag ref ${{ steps.mk.outputs.tag }} not present"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.mk.outputs.tag }}
          name: ${{ steps.mk.outputs.tag }}
          body: |
            Automated release for ${{ steps.mk.outputs.tag }} (triggered by push to ${{ github.ref_name }})

            **Commit Message:** ${{ github.event.head_commit.message }}
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Output release URL
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release view "${{ steps.mk.outputs.tag }}" --json url --jq .url
