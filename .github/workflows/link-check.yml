name: Link check
on:
  pull_request:
    paths: ["**/*.html", "**/*.md"]
  schedule:
    - cron: "0 13 * * 1"
  workflow_dispatch:
jobs:
  lychee:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4
      - uses: step-security/harden-runner@v2
        with: { egress-policy: audit }
      - id: lychee
        uses: lycheeverse/lychee-action@v2
        with:
          args: --base . --no-progress -accept 200..205,999 --verbose "./**/*.html" "./**/*.md"
          format: markdown
          output: ./lychee/out.md
          fail: false
      - if: steps.lychee.outputs.exit_code != 0 && github.event_name == 'schedule'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "Broken links detected"
          content-filepath: ./lychee/out.md
          labels: report, automated-issue
      - if: steps.lychee.outputs.exit_code != 0 && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const issue_number = context.payload.pull_request.number;
            const body = fs.readFileSync('./lychee/out.md', 'utf8');
            await github.issues.createComment({
              ...context.repo,
              issue_number,
              body
            });